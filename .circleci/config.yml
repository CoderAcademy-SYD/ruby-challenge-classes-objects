version: 2 # use CircleCI 2.0
jobs: # a collection of steps
  build: # runs not using Workflows must have a `build` job as entry point
    docker: # run the steps with Docker
    - image: circleci/ruby:2.4.2-jessie-node # ...with this image as the primary container; this is where all `steps` will run
    steps: # a collection of executable commands
    - checkout # special step to check out source code to working directory

    # Which version of bundler?
    - run:
        name: Which bundler?
        command: bundle -v

    - run:
        name: Bundle Install
        command: bundle check || bundle install

    - run:
        name: Run rspec
        command: |
          bundle exec rspec --profile 10 \
                            --format RspecJunitFormatter \
                            --out test_results/rspec.xml \
                            --format progress \
                            $(circleci tests glob "spec/*_spec.rb" | circleci tests split --split-by=timings)

    # Save test results for timing analysis
    - store_test_results:
        path: test_results
    # See https://circleci.com/docs/2.0/deployment-integrations/ for example deploy configs